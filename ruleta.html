<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Simulador Actuarial - MODO AUTO</title>
    <style>
        :root { --primary: #2563eb; --danger: #ef4444; --success: #10b981; --dark: #1e293b; --auto: #8b5cf6; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f4f8; display: flex; justify-content: center; padding: 20px; color: var(--dark); }
        .container { background: white; padding: 2rem; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); max-width: 600px; width: 100%; text-align: center; }
        
        .dashboard { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        .panel { background: #f8fafc; padding: 15px; border-radius: 15px; border: 1px solid #e2e8f0; }
        .big-num { display: block; font-size: 1.8rem; font-weight: bold; color: var(--primary); }

        .stage { position: relative; height: 220px; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; background: #fff; border-radius: 20px; margin: 10px 0; border: 1px solid #f1f5f9; }
        .year-display { font-size: 6rem; font-weight: 800; color: #e2e8f0; position: absolute; z-index: 1; transition: all 0.2s; }
        .emoji { font-size: 80px; transition: all 0.2s; z-index: 2; position: relative; }
        
        .floating-value { position: absolute; color: var(--success); font-weight: bold; font-size: 2rem; opacity: 0; pointer-events: none; z-index: 3; }
        @keyframes floatUp {
            0% { transform: translateY(20px); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translateY(-120px); opacity: 0; }
        }

        .roulette-container { position: relative; width: 150px; height: 150px; margin: 0 auto 20px; }
        #canvas { border-radius: 50%; transition: transform 0.5s cubic-bezier(0.1, 0, 0.2, 1); width: 100%; height: 100%; }
        .pointer { position: absolute; top: -5px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 16px solid #333; z-index: 10; }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: 0.2s; }
        button:disabled { background: #cbd5e1; }
        #autoBtn { background: var(--auto); }
        #autoBtn.active { background: #4c1d95; box-shadow: inset 0 2px 10px rgba(0,0,0,0.3); }
        #resetBtn { background: var(--dark); grid-column: span 2; }

        .history-section { margin-top: 20px; }
        .scroll-table { max-height: 150px; overflow-y: auto; border-radius: 12px; border: 1px solid #f1f5f9; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { position: sticky; top: 0; background: #f8fafc; padding: 8px; border-bottom: 1px solid #eee; }
        td { padding: 6px; border-bottom: 1px solid #f1f5f9; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <div class="dashboard">
        <div class="panel">Simulaciones<span class="big-num" id="totalSims">0</span></div>
        <div class="panel">VP Promedio<span class="big-num" id="avgVP">$0.00</span></div>
    </div>

    <div class="stage">
        <div id="floatVal" class="floating-value"></div>
        <div class="year-display" id="yearsCount">0</div>
        <div id="charEmoji" class="emoji">游땕</div>
    </div>

    <div class="roulette-container">
        <div class="pointer"></div>
        <canvas id="canvas" width="200" height="200"></canvas>
    </div>

    <div class="controls">
        <button id="spinBtn" onclick="girar()">Girar (A침o <span id="btnYear">1</span>)</button>
        <button id="autoBtn" onclick="toggleAuto()">Modo Auto: OFF</button>
        <button id="resetBtn" onclick="manualReset()" style="display:none;">Nueva Persona</button>
    </div>

    <div class="history-section">
        <div class="scroll-table">
            <table>
                <thead>
                    <tr><th>Sim #</th><th>Muerte</th><th>VP Pagado</th></tr>
                </thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    let a침oActual = 1;
    let finalizado = false;
    let rotation = 0;
    let totalSimulaciones = 0;
    let sumaVP = 0;
    let isAuto = false;
    let autoTimer = null;

    function draw() {
        const slice = (Math.PI * 2) / 20;
        ctx.clearRect(0,0,200,200);
        ctx.beginPath(); ctx.moveTo(100,100);
        ctx.arc(100,100,98, -Math.PI/2, -Math.PI/2 + (slice * a침oActual));
        ctx.fillStyle = '#ef4444'; ctx.fill();
        ctx.beginPath(); ctx.moveTo(100,100);
        ctx.arc(100,100,98, -Math.PI/2 + (slice * a침oActual), -Math.PI/2 + (Math.PI*2));
        ctx.fillStyle = '#10b981'; ctx.fill();
        ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.stroke();
    }

    function toggleAuto() {
        isAuto = !isAuto;
        const btn = document.getElementById('autoBtn');
        btn.innerText = isAuto ? "Modo Auto: ON" : "Modo Auto: OFF";
        btn.classList.toggle('active');
        if (isAuto && !finalizado) girar();
    }

    function girar() {
        if(finalizado) return;
        document.getElementById('spinBtn').disabled = true;
        
        // M치s r치pido en modo auto
        const speed = isAuto ? 300 : 600; 
        canvas.style.transition = `transform ${speed/1000}s cubic-bezier(0.1, 0, 0.2, 1)`;
        
        const extraDeg = Math.floor(Math.random() * 360) + 720; 
        rotation += extraDeg;
        canvas.style.transform = `rotate(${rotation}deg)`;

        setTimeout(() => {
            const normalizedAngle = (360 - (rotation % 360)) % 360;
            const landInRed = normalizedAngle < (a침oActual / 20 * 360);
            
            if (landInRed) morir();
            else sobrevivir();
        }, speed + 50);
    }

    function sobrevivir() {
        document.getElementById('yearsCount').innerText = a침oActual;
        a침oActual++;
        document.getElementById('btnYear').innerText = a침oActual;
        draw();
        if (isAuto) {
            autoTimer = setTimeout(girar, 100);
        } else {
            document.getElementById('spinBtn').disabled = false;
        }
    }

    function morir() {
        finalizado = true;
        const vp = 10000 / Math.pow(1.05, a침oActual);
        
        document.getElementById('yearsCount').innerText = a침oActual;
        document.getElementById('yearsCount').style.color = '#fecaca';
        document.getElementById('charEmoji').innerText = "游";
        
        const floatVal = document.getElementById('floatVal');
        floatVal.innerText = `+$${vp.toLocaleString(undefined, {minimumFractionDigits:2})}`;
        floatVal.style.animation = "none";
        floatVal.offsetHeight; 
        floatVal.style.animation = "floatUp 1s ease-out forwards";

        totalSimulaciones++;
        sumaVP += vp;
        document.getElementById('totalSims').innerText = totalSimulaciones;
        document.getElementById('avgVP').innerText = `$${(sumaVP / totalSimulaciones).toLocaleString(undefined, {minimumFractionDigits:2})}`;
        
        const row = document.getElementById('historyBody').insertRow(0);
        row.innerHTML = `<td>${totalSimulaciones}</td><td>A침o ${a침oActual}</td><td>$${vp.toFixed(2)}</td>`;

        if (isAuto) {
            autoTimer = setTimeout(resetSim, 1200); // Espera a que termine la animaci칩n del "alma"
        } else {
            document.getElementById('spinBtn').style.display = "none";
            document.getElementById('resetBtn').style.display = "block";
        }
    }

    function manualReset() {
        resetSim();
    }

    function resetSim() {
        a침oActual = 1;
        finalizado = false;
        document.getElementById('charEmoji').innerText = "游땕";
        document.getElementById('yearsCount').innerText = "0";
        document.getElementById('yearsCount').style.color = '#e2e8f0';
        document.getElementById('btnYear').innerText = "1";
        document.getElementById('spinBtn').style.display = "block";
        document.getElementById('spinBtn').disabled = false;
        document.getElementById('resetBtn').style.display = "none";
        draw();
        if (isAuto) girar();
    }

    draw();
</script>

</body>
</html>
